name: Code Assessment

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:
    inputs:
      scope:
        description: 'Assessment scope'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - incremental
      repository:
        description: 'Repository to assess'
        required: false
        default: 'current'

env:
  NODE_VERSION: '18'
  ASSESSMENT_TIMEOUT: 900  # 15 minutes

jobs:
  assess:
    name: Run Code Assessment
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run AUDITOR assessment
        id: assess
        run: |
          if [ "${{ github.event.inputs.scope }}" = "incremental" ]; then
            npm run assess:incremental
          else
            npm run assess
          fi
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          LINEAR_TEAM_ID: ${{ secrets.LINEAR_TEAM_ID }}
          ASSESSMENT_SCOPE: ${{ github.event.inputs.scope || 'full' }}

      - name: Parse assessment results
        id: parse
        run: |
          if [ -f assessment-report.json ]; then
            echo "issues=$(jq '.issues | length' assessment-report.json 2>/dev/null || echo 0)" >> $GITHUB_OUTPUT
            echo "complexity=$(jq '.metrics.complexity' assessment-report.json 2>/dev/null || echo 0)" >> $GITHUB_OUTPUT
            echo "coverage=$(jq '.metrics.coverage' assessment-report.json 2>/dev/null || echo 0)" >> $GITHUB_OUTPUT
          else
            echo "issues=0" >> $GITHUB_OUTPUT
            echo "complexity=0" >> $GITHUB_OUTPUT
            echo "coverage=0" >> $GITHUB_OUTPUT
          fi

      - name: Create Linear tasks
        if: steps.parse.outputs.issues > 0 && vars.LINEAR_API_KEY != ''
        run: npm run linear:create-issues || echo "Linear integration not configured, skipping"
        continue-on-error: true
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          LINEAR_TEAM_ID: ${{ secrets.LINEAR_TEAM_ID }}
          LINEAR_PROJECT_ID: ${{ secrets.LINEAR_PROJECT_ID }}

      - name: Upload assessment report
        uses: actions/upload-artifact@v4
        with:
          name: assessment-report-${{ github.run_id }}
          path: |
            assessment-report.json
            assessment-summary.md
          retention-days: 30

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('assessment-summary.md', 'utf8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## üîç Code Assessment Report\n\n${summary}`
            });

      - name: Update metrics dashboard
        if: secrets.METRICS_ENDPOINT != ''
        run: |
          curl -X POST ${{ secrets.METRICS_ENDPOINT }} \
            -H "Authorization: Bearer ${{ secrets.METRICS_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d @assessment-report.json || echo "Metrics endpoint not configured"
        continue-on-error: true

      - name: Check quality gates
        id: quality
        run: |
          complexity="${{ steps.parse.outputs.complexity }}"
          coverage="${{ steps.parse.outputs.coverage }}"

          echo "üìä Quality Metrics:"
          echo "  - Complexity: $complexity"
          echo "  - Coverage: $coverage%"
          echo "  - Issues: ${{ steps.parse.outputs.issues }}"

          # Only fail if we have actual data and thresholds are exceeded
          if [ "$complexity" != "0" ] && (( $(echo "$complexity > 10" | bc -l 2>/dev/null || echo 0) )); then
            echo "‚ö†Ô∏è Complexity threshold exceeded: $complexity > 10"
          fi

          if [ "$coverage" != "0" ] && (( $(echo "$coverage < 80" | bc -l 2>/dev/null || echo 0) )); then
            echo "‚ö†Ô∏è Coverage below target: $coverage < 80"
          fi

      - name: Create summary
        if: always()
        run: |
          echo "## üîç Assessment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Issues Found**: ${{ steps.parse.outputs.issues }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Complexity**: ${{ steps.parse.outputs.complexity }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Coverage**: ${{ steps.parse.outputs.coverage }}%" >> $GITHUB_STEP_SUMMARY